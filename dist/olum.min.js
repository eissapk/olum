/**
* @name Olum.js
* @version 0.1.3
* @copyright 2021
* @author Eissa Saber
* @license MIT
*/
"use strict";var _this=void 0;function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o=0;o<t.length;o++){var r=t[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var o=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(o="Object"===o&&e.constructor?e.constructor.name:o)||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,r=new Array(t);o<t;o++)r[o]=e[o];return r}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}!function(e,t){"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=t():"function"==typeof define&&define.amd?define(t):(t=t(),e.Olum=t.Olum,e.$=t.$,e.debug=t.debug)}("undefined"!=typeof self?self:void 0,function(){function t(e){return"“"+e+"”"}function a(){return!!["localhost","127.0.0.1"].includes(location.hostname)}function l(e){return!!(d(e)&&Array.isArray(e)&&e.length)}function c(e){return!(null==e)}function u(e,t){return!!e.hasOwnProperty(t)}function s(e,t,o){Object.defineProperty(e,t,{value:o,writable:!0,configurable:!0})}function p(e){var t="err"==(t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"log")?"error":t}var f="undefined"!=typeof self?self:_this,h="Olum [warn]:",d=function(e){return!(null===e||"object"!==_typeof(e))};String.prototype.upper=function(){return this.toUpperCase()},String.prototype.lower=function(){return this.toLowerCase()},String.prototype.cap=function(){return this.toLowerCase().split(" ").map(function(e){return e.charAt(0).toUpperCase()+e.slice(1)}).join(" ")};function o(e){var t,o="err"==(o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"log")?"error":o;a()&&(Array.isArray(e)?(t=console)[o].apply(t,_toConsumableArray(e)):console[o](e))}function n(o,e){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:document;return"string"!=typeof o?(!Array.isArray(o)&&o&&o instanceof Element&&(o.get=function(e,t){return n(e,t,o)}),o):(t=[].slice.call(t.querySelectorAll(o)),l(t)?e?t:t[0]:e?[]:null)}function e(e,t){return this.addEventListener(e,t,2<arguments.length&&void 0!==arguments[2]&&arguments[2])}function r(e,t){return this.removeEventListener(e,t,2<arguments.length&&void 0!==arguments[2]&&arguments[2])}return Element.prototype.on=e,Element.prototype.off=r,Document.prototype.on=e,Document.prototype.off=r,f.on=e,f.off=r,{Olum:function(){function i(e){var t=e.mode,o=e.root,r=e.el,n=e.prefix,a=e.err,e=e.routes;_classCallCheck(this,i),_defineProperty(this,"isFrozen",!1),_defineProperty(this,"routes",[]),_defineProperty(this,"pushStateAPI",!!f.history.pushState),this instanceof i||console.error("".concat(h," can't invoke ").concat("“Olum constructor”"," without new keyword")),this.setMode(t),this.setRoot(o),this.setPrefix(n),this.setErr(a),this.hasRootElm(r)?this.hasRoutes(e)?(this.popStateEvent=new PopStateEvent("popstate"),this.viewLoaded=new CustomEvent("viewLoaded",{detail:{},bubbles:!0,cancelable:!0,composed:!1}),this.listen()):console.error("".concat(h," couldn't find ").concat("“routes property”"," @ router instance or it's empty. \nmake sure that ").concat("“routes property”",' has components \ne.g. routes = [{ path: "/", comp: Home }]')):console.error("".concat(h," couldn't find a value for ").concat("“el property”",' @ router instance. \nmake sure it has the right selector e.g. el:"#app" \nand ').concat("“Root Element”",' exists in dom e.g. <div id="app"></div>'))}return _createClass(i,[{key:"hasRootElm",value:function(e){var t=document.querySelector(e);return!(!e||!t)&&(this.rootCompName=e.replace(/\#|\./,"").cap(),this.appMarkup=t,f.olum={rootCompName:this.rootCompName,el:e},!0)}},{key:"hasRoutes",value:function(e){var t=this;return!(!e||!l(e))&&(e.forEach(function(e){return t.addRoute(e.path,e.comp)}),!0)}},{key:"setPrefix",value:function(e){e?this.prefix=e:(this.prefix=null,o("".concat(h," couldn't find ").concat("“prefix property”"," @ router instance. \nfalling back to default component tag e.g. <ComponentName/>"),"warn"))}},{key:"setRoot",value:function(e){e?this.root=e:(this.root="/",o("".concat(h," couldn't find ").concat("“root property”"," @ router instance. \nfalling back to default value: ").concat("“/”"),"warn"))}},{key:"setErr",value:function(e){e?this.err=this.resolve(e):(this.err=null,o("".concat(h," couldn't find ").concat("“err property”"," @ router instance. \nfalling back to default 404 page"),"warn"))}},{key:"setMode",value:function(e){e?this.pushStateAPI?this.mode=e:(this.mode="hash",o("".concat(h," mode is set to ").concat("“hash”"," \n").concat("“history”"," is not supported!"),"warn")):(this.mode=this.pushStateAPI?"history":"hash",o("".concat(h," couldn't find ").concat("“mode property”"," @ router instance. \nfalling back to available default mode: ").concat(t(this.mode)),"warn"))}},{key:"addRoute",value:function(e,t){var o=this;this.routes.push({path:this.resolve(e),cb:function(){return o.inject(t)}})}},{key:"delRoute",value:function(o){var r=this;this.routes.forEach(function(e){var t;e.path===r.resolve(o)&&(t=r.routes,e=e,t.length&&-1<t.indexOf(e)&&t.splice(t.indexOf(e),1))})}},{key:"flush",value:function(){this.routes=[]}},{key:"resolve",value:function(e){var t=this.clear(this.root);return e=this.clear(e),e="/"!==(e="/"!==this.root?"/"+t+"/"+e:"/"+e)?e.replace(/\/$/g,""):e}},{key:"clear",value:function(e){var t=new RegExp("^[#/]{1,}|/$","g");return e=e.lower().trim().replace(t,"")}},{key:"freeze",value:function(){this.isFrozen=!0}},{key:"unfreeze",value:function(){this.isFrozen=!1}},{key:"listen",value:function(){var n=this;f.on("popstate",function(){p(["Dispatched Popstate",n.routes]);var e,t=n.getRoute(),o="/"+n.clear(n.root),t="hash"===n.mode&&"/"!==n.root?(t=o+t).replace(/\/$/,""):t,r=n.routes.find(function(e){return e.path===t?e:""===t||"/"===t||t.includes("index.html")?e.path===o:void 0});c(r)?n.isFrozen||r.cb():c(n.err)?(e=n.routes.find(function(e){return e.path===n.err}),c(e)?e.cb():console.error("".concat(h," unmached path of ").concat("“err property”"," @ router instance."))):n.appMarkup.innerHTML="Not Found!",p({current:t,route:r})}),dispatchEvent(this.popStateEvent)}},{key:"getRoute",value:function(){var e="";return"history"===this.mode?e=this.clear(decodeURI(location.pathname)):"hash"===this.mode&&(e=this.clear(decodeURI(location.hash))),"/"+e}},{key:"navigate",value:function(e){var t;this.unfreeze(),e=this.resolve(e),"history"===this.mode?(f.history.pushState({},"",e),p("Pushed to history"),dispatchEvent(this.popStateEvent)):"hash"===this.mode&&("/"===this.root?location.href="".concat(location.href.replace(/\#.*/g,""),"#").concat(e):(t=(t=this.clear(this.root)).replace(/\//g,"\\/"),t=new RegExp("\\/".concat(t),"g"),t="/"+(t=e.replace(t,"")).replace(/^\//g,""),location.href="".concat(location.href.replace(/\#.*/g,""),"#").concat(t)))}},{key:"to",value:function(){var r=this,e=n("[to]",!0);l(e)&&e.forEach(function(e){"A"===e.nodeName&&e.setAttribute("href","javascript:void(0)"),_toConsumableArray(e.children).forEach(function(e){return e.style.pointerEvents="none"}),e.on("click",function(e){var t=e.target.getAttribute("to"),o=r.resolve(t),e=r.getRoute();o!==e&&r.navigate(t)})})}},{key:"active",value:function(t){var o=this,e=n("[to]",!0);l(e)&&e.forEach(function(e){o.resolve(e.getAttribute("to"))===t?e.classList.add("active"):e.classList.remove("active")})}},{key:"buildTree",value:function(e){var a=[];return function e(t){if(u(t,"components")&&(n=t.components,!!(d(n)&&Array.isArray(Object.keys(n))&&Object.keys(n).length)))for(var o in t.components){var r={};s(r,"parent",t.name),s(r,"child",{}),s(r.child,"name",o);o=new t.components[o];s(r.child,"data",o.data()),a.push(r),u(r,"child")&&u(r.child,"data")&&e(r.child.data)}var n}(e),p(["compsArr",a]),a}},{key:"label",value:function(e,t){var r=/(olum-component=[\"\']([^\"|\']*)[\"\'])|(olum-component)/gi,n=/<[a-z]+(>|.*?[^?]>)/gi,a=/\>/gi,o=_toConsumableArray(t),i=e;return o.forEach(function(e){var t,o=e.child.data.name||"undefined";e.child&&e.child.data&&u(e.child.data,"template")&&((t=e.child.data).template=t.template.replace(r,""),e=t.template.match(n),l(e)&&(t.template=t.template.replace(e[0],e[0].replace(a,' olum-component="'.concat(o,'">')))))}),i.template&&(t=i.name||"undefined",i.template=i.template.replace(r,""),e=i.template.match(n),l(e)&&(i.template=i.template.replace(e[0],e[0].replace(a,' olum-component="'.concat(t,'" router-view="').concat(t,'">'))))),this.appMarkup.setAttribute("olum-component",this.rootCompName),{entry:i,compsArr:o}}},{key:"inject",value:function(e){var t,r,n=this;e&&"function"==typeof e?(t=(new e).data(),e=this.buildTree(t),e=a()?this.label(t,e):{entry:t,compsArr:e},r=this.merge(e),this.buildStyles(r.style),this.appMarkup.innerHTML=r.template,setTimeout(function(){n.active(n.getRoute()),n.to();var o=Object.keys(r.script);(function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;r.script[o[t]](),t===o.length-1&&c(n.viewLoaded)&&(dispatchEvent(n.viewLoaded),p("viewLoaded")),t+1<=o.length-1&&e(t+1)})()},0)):console.error("".concat(h," ").concat("“View argument”"," is missing or it's not a constructor function! @ Olum.inject(View)"))}},{key:"buildStyles",value:function(e){var t="olum_style_tag",o=document.getElementById(t);o||((o=document.createElement("style")).id=t,document.head.append(o)),o.innerHTML=e}},{key:"merge",value:function(e){var a=this,t=e.entry,e=e.compsArr,i=t.template||"",c=t.style||"",u={};return t.render&&(u[0]=t.render),l(e)&&e.forEach(function(e,t){var o=e.child.data,r=o.template||"",n=o.style||"",e=o.render||null,o=null!==a.prefix?a.prefix+"-"+o.name:o.name,o=new RegExp("<(".concat(o,"\\s{0,})\\/>"),"gi");i=i.replace(o,r),c+=n,null!==e&&(u[t+1]=e)}),{template:i,style:c,script:u}}}]),i}(),$:n,debug:o}});